<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Payment</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <div id="payment-view">
    <div class="header">
      <div onclick="history.back()" style="font-size: 24px; cursor: pointer;">‚Üê</div>
      <div style="font-size: 18px; font-weight: bold; flex:1; margin-left:15px;">Payments</div>
    </div>
    
    <div class="steps-header">
      <div class="step"><div class="step-circle">‚úì</div>Address</div>
      <div class="step"><div class="step-circle">‚úì</div>Summary</div>
      <div class="step active"><div class="step-circle">3</div>Payment</div>
    </div>

    <div class="container" style="text-align:center;">
      <h3 style="color:var(--gray);">Amount Payable</h3>
      <h1 style="margin: 10px 0; color:var(--text);" id="pay-amt">‚Çπ0</h1>
    </div>

    <div class="container">
      <h3>Select Payment Method</h3>
      <div id="payment-options"></div>
    </div>
    
    <!-- Cash on Delivery fallback -->
    <div class="container" onclick="processPayment('COD', '')" style="display:flex; align-items:center; gap:15px; cursor:pointer; border:1px solid #eee; padding:15px; border-radius:4px; margin-top:10px;">
      <div style="width: 40px; height: 40px; background: #eee; border-radius: 50%; display:flex; align-items:center; justify-content:center; font-size:20px;">üíµ</div>
      <div style="font-size:16px; font-weight:500;">Cash on Delivery</div>
    </div>
  </div>

  <!-- Processing Spinner -->
  <div id="processing-view" style="display:none; text-align:center; padding-top:100px;">
    <div class="loader"></div>
    <h3>Processing Payment...</h3>
    <p style="color:var(--gray);">Please do not press back or refresh</p>
  </div>

  <!-- Success Screen -->
  <div id="success-view" class="success-screen">
    <img src="https://cdn-icons-png.flaticon.com/512/190/190411.png" alt="Success">
    <h2 style="color:var(--green);">Order Placed Successfully!</h2>
    <p style="color:var(--gray);">Thank you for shopping with us.</p>
    <br><br>
    <button class="btn-success" onclick="location.href='index.html'">Continue Shopping</button>
  </div>

  <script src="script.js"></script>
  <script>
    let totals = getCartTotals();
    document.getElementById('pay-amt').innerText = `‚Çπ${totals.totalPrice}`;

    let links = getLS('paymentLinks');
    let html = '';
    
    const gateways = [
      { id: 'gpay', name: 'Google Pay', icon: 'https://cdn-icons-png.flaticon.com/512/6124/6124998.png' },
      { id: 'phonepe', name: 'PhonePe', icon: 'https://download.logo.wine/logo/PhonePe/PhonePe-Logo.wine.png' },
      { id: 'paytm', name: 'Paytm', icon: 'https://cdn-icons-png.flaticon.com/512/825/825454.png' }
    ];

    gateways.forEach(g => {
      if (links[g.id]) {
        let checkoutLink = `${links[g.id]}&am=${totals.totalPrice}`;
        html += `
          <div onclick="processPayment('${g.name}', '${checkoutLink}')" style="display:flex; align-items:center; gap:15px; cursor:pointer; border:1px solid #eee; padding:15px; border-radius:4px; margin-bottom:10px;">
            <img src="${g.icon}" width="40" height="40" style="object-fit:contain;">
            <div style="font-size:16px; font-weight:500;">${g.name}</div>
          </div>
        `;
      }
    });
    
    if(html === '') html = "<p style='color:var(--gray); font-size:12px;'>No UPI methods configured by Admin.</p>";
    document.getElementById('payment-options').innerHTML = html;

    function processPayment(method, link) {
      if (link) window.open(link, '_blank'); // Open UPI link if available
      
      document.getElementById('payment-view').style.display = 'none';
      document.getElementById('processing-view').style.display = 'block';

      setTimeout(() => {
        // Create Order
        let orders = getLS('orders');
        let orderData = {
          id: 'OD' + Math.floor(Math.random() * 1000000000),
          date: new Date().toLocaleString(),
          items: getLS('cart'),
          address: getLS('shippingAddress'),
          total: totals.totalPrice,
          method: method,
          status: 'Pending'
        };
        orders.unshift(orderData); // Add to beginning
        setLS('orders', orders);

        // Clear Cart
        setLS('cart', []);

        // Show Success
        document.getElementById('processing-view').style.display = 'none';
        document.getElementById('success-view').style.display = 'block';
      }, 2000);
    }
  </script>
</body>
</html>
